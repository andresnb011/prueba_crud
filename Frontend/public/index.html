<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Clientes</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <header class="header">
    <h1>Gestor de Clientes</h1>
  </header>

  <!-- Formulario -->
  <form id="clienteForm">
    <input type="hidden" id="clienteId">
    <div class="form-row">
      <input type="text" id="nombre" placeholder="Nombre (m√≠nimo 3 caracteres)" required>
      <input type="text" id="documento" placeholder="Documento (m√≠nimo 6 d√≠gitos)" required>
    </div>
    <div class="form-row">
      <input type="email" id="correo" placeholder="Correo" required>
      <select id="estado" class="short">
        <option value="ACTIVO">ACTIVO</option>
        <option value="INACTIVO">INACTIVO</option>
      </select>
    </div>
    <div class="form-buttons">
      <button type="submit">Guardar</button>
      <button type="button" onclick="cancelarEdicion()">Cancelar</button>
    </div>
    <span class="error" id="errorMsg"></span>
  </form>

  <!-- Buscador y Filtro -->
  <div class="search-filter">
    <input type="text" id="buscador" placeholder="üîç Buscar por nombre o documento">
    <div class="filter-group">
      <label for="filtroEstado">Filtrar:</label>
      <select id="filtroEstado" onchange="filtrarClientes()">
        <option value="todos">Todos</option>
        <option value="ACTIVO">Activos</option>
        <option value="INACTIVO">Inactivos</option>
      </select>
    </div>
  </div>

  <!-- Tabla -->
  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Documento</th>
        <th>Correo</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="clientesTable"></tbody>
  </table>

  <script>
    const API_URL = 'http://localhost:4000/api/clientes';
    let clientes = [];
    const form = document.getElementById('clienteForm');
    const errorMsg = document.getElementById('errorMsg');
    const table = document.getElementById('clientesTable');
    const buscador = document.getElementById('buscador');

    async function loadClientes() {
      try {
        const response = await fetch(API_URL);
        clientes = await response.json();
        aplicarFiltros();
      } catch (error) {
        console.error('Error cargando clientes:', error);
      }
    }

    function renderClientes(lista) {
      table.innerHTML = '';
      lista.forEach((c) => {
        const row = `<tr>
          <td data-label="Nombre">${c.nombre}</td>
          <td data-label="Documento">${c.documento}</td>
          <td data-label="Correo">${c.correo}</td>
          <td data-label="Estado">${c.estado}</td>
          <td data-label="Acciones">
            <button onclick="editarCliente(${c.id})">‚úèÔ∏è Editar</button>
            <button class="btn-danger" onclick="eliminarCliente(${c.id})">üóëÔ∏è Eliminar</button>
          </td>
        </tr>`;
        table.innerHTML += row;
      });
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      console.log('Formulario enviado');
      errorMsg.textContent = '';

      const id = document.getElementById('clienteId').value;
      const nombre = document.getElementById('nombre').value.trim();
      const documento = document.getElementById('documento').value.trim();
      const correo = document.getElementById('correo').value.trim();
      const estado = document.getElementById('estado').value;

      console.log('Datos:', { id, nombre, documento, correo, estado });

      if (nombre.length < 3) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Nombre demasiado corto'
        });
        return;
      }
      if (!/^\d{6,}$/.test(documento)) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Documento inv√°lido'
        });
        return;
      }
      if (!/\S+@\S+\.\S+/.test(correo)) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Correo inv√°lido'
        });
        return;
      }

      const cliente = { nombre, documento, correo, estado };
      console.log('Cliente a enviar:', cliente);

      try {
        let response;
        if (id) {
          console.log('Editando cliente ID:', id);
          response = await fetch(`${API_URL}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cliente)
          });
        } else {
          console.log('Creando nuevo cliente');
          response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cliente)
          });
        }
        console.log('Respuesta status:', response.status);
        if (!response.ok) {
          const error = await response.json();
          console.log('Error del servidor:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.error || 'Error al guardar'
          });
          return;
        }
        const result = await response.json();
        console.log('Resultado:', result);
        await loadClientes();
        form.reset();
        document.getElementById('clienteId').value = '';
        document.getElementById('documento').disabled = false;
        Swal.fire({
          icon: 'success',
          title: '√âxito',
          text: 'Cliente guardado exitosamente',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        console.error('Error de conexi√≥n:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error de conexi√≥n',
          text: 'No se pudo conectar al servidor'
        });
      }
    });

    function editarCliente(id) {
      const c = clientes.find(c => c.id == id);
      document.getElementById('clienteId').value = c.id;
      document.getElementById('nombre').value = c.nombre;
      document.getElementById('documento').value = c.documento;
      document.getElementById('correo').value = c.correo;
      document.getElementById('estado').value = c.estado;
      document.getElementById('documento').disabled = true;
    }

    function cancelarEdicion() {
      form.reset();
      document.getElementById('clienteId').value = '';
      document.getElementById('documento').disabled = false;
    }

    async function eliminarCliente(id) {
      const result = await Swal.fire({
        title: '¬øEst√°s seguro?',
        text: '¬øDeseas eliminar este cliente?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
          if (response.ok) {
            await loadClientes();
            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'Cliente eliminado exitosamente',
              timer: 2000,
              showConfirmButton: false
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Error al eliminar'
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error de conexi√≥n',
            text: 'No se pudo conectar al servidor'
          });
        }
      }
    }

    function aplicarFiltros() {
      const term = buscador.value.toLowerCase();
      const estadoFiltro = document.getElementById('filtroEstado').value;
      let filtrados = clientes.filter(c =>
        c.nombre.toLowerCase().includes(term) ||
        c.documento.includes(term)
      );
      if (estadoFiltro !== 'todos') {
        filtrados = filtrados.filter(c => c.estado === estadoFiltro);
      }
      renderClientes(filtrados);
    }

    function filtrarClientes() {
      aplicarFiltros();
    }

    buscador.addEventListener('input', aplicarFiltros);

    loadClientes();
  </script>
</body>
</html>
